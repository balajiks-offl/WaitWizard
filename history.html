<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>History - WaitWizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { background: #f5f7fa; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 40px 0; }
    .container { width: 95%; max-width: 1100px; margin: 0 auto; padding-bottom: 40px; position: relative; box-sizing: border-box; }
    h1 { color: #365f6b; font-size: 2.8rem; font-weight: bold; text-align: center; margin-bottom: 8px; }
    p.subtitle { color: #5a7484; text-align: center; font-size: 1.15rem; margin-bottom: 30px; }
    .table-responsive { width:100%; overflow-x:auto; margin-top: 20px; }
    table { width: 100%; min-width: 800px; border-collapse: separate; border-spacing: 0; border-radius: 18px 18px 0 0; background: #fff; box-shadow: 0 8px 28px rgba(40,60,120,0.10); overflow: hidden; margin-bottom: 0;}
    thead th { background: #f5f7fa; color: #365f6b; font-weight: bold; font-size: 1.05rem; padding: 14px 12px; border-bottom: 2px solid #e9ecf2; letter-spacing: 0.5px; text-align: left; white-space: nowrap;}
    tbody td { padding: 13px 12px; font-size: 1.02rem; font-weight: 500; color: #355f6b; border-bottom: 1px solid #f2f2f2; vertical-align: middle; white-space: nowrap;}
    tbody tr:last-child td { border-bottom: none; }
    tbody .loading-row td { text-align: center; font-size: 1.15rem; color: #5a7484; font-weight: 500; padding: 30px 0;}
    .ticket-id { font-weight: 700; font-family: monospace; color: #365f6b; min-width: 70px;}
    .action-btn { background: #4CAF50; border: none; color: white; padding: 6px 14px; font-size: 0.95rem; border-radius: 5px; cursor: pointer; transition: background 0.3s ease;}
    .action-btn:hover { background: #45a049; }
    .no-history { text-align: center; color: #5a7484; font-size: 1.2rem; margin-top: 40px; display: none; }
    #modalOverlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.3s ease;}
    #modalOverlay.show { display: flex; opacity: 1; }
    #ticketDetailsModal { background: #fff; border-radius: 16px; box-shadow: 0 6px 22px rgba(60,80,120,0.25); padding: 28px 22px; max-width: 450px; width: 90%; transform: translateY(-40px); opacity: 0; transition: all 0.3s ease;}
    #modalOverlay.show #ticketDetailsModal { transform: translateY(0); opacity: 1; }
    #ticketDetailsModal h3 { margin-top: 0; margin-bottom: 20px; color: #365f6b; }
    #ticketDetailsModal div { margin-bottom: 12px; color: #365f6b; font-size: 1.05rem;}
    #ticketDetailsModal button.close-btn { background: #e74c3c; border: none; color: white; padding: 10px 22px; cursor: pointer; border-radius: 6px; font-size: 1rem; transition: background 0.3s ease; margin-top: 10px; display:block; width:100%;}
    #ticketDetailsModal button.close-btn:hover { background: #c0392b;}
    @media (max-width: 900px) { h1{font-size:2.1rem;} .table-responsive{min-width:375px;} table{min-width:600px;} }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="container">
    <h1>History</h1>
    <p class="subtitle">View your full ticket history (Open, Closed, Cancelled, Swapped and more)</p>
    <div class="table-responsive">
      <table id="historyTable">
        <thead>
          <tr>
            <th>Ticket ID</th>
            <th>Appointment Date</th>
            <th>Appointment Time</th>
            <th>Status</th>
            <th>Type</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr class="loading-row"><td colspan="6">Loading...</td></tr>
        </tbody>
      </table>
    </div>
    <div id="noHistory" class="no-history">No ticket history found.</div>
  </div>
  <div id="modalOverlay">
    <div id="ticketDetailsModal">
      <h3>Ticket Details</h3>
      <div id="modalContent"></div>
      <button class="close-btn" onclick="closeModal()">Close</button>
    </div>
  </div>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyCsy799iekDizixCe0LEGJWC-msj6MsvIs",
      authDomain: "digitalqueuesystem.firebaseapp.com",
      databaseURL: "https://digitalqueuesystem-default-rtdb.firebaseio.com",
      projectId: "digitalqueuesystem",
      storageBucket: "digitalqueuesystem.appspot.com",
      messagingSenderId: "934641075368",
      appId: "1:934641075368:web:fa23d50116ef2fd92e6e9d",
      measurementId: "G-TJESH8R15H"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Hash a string to a 5-digit ticket number
    function ticketIdToFiveDigit(ticketId) {
      let hash = 0;
      for (let i = 0; i < ticketId.length; i++) {
        hash = ((hash << 5) - hash) + ticketId.charCodeAt(i);
        hash |= 0;
      }
      const num = Math.abs(hash % 100000);
      return num.toString().padStart(5, '0');
    }

    function renderHistory(tickets) {
      const historyBody = document.getElementById('historyBody');
      const noHistory = document.getElementById('noHistory');
      if (!tickets.length) {
        historyBody.innerHTML = '';
        historyBody.style.display = 'none';
        noHistory.style.display = 'block';
        return;
      }
      noHistory.style.display = 'none';
      historyBody.style.display = '';
      historyBody.innerHTML = '';
      tickets.forEach(t => {
        const ticketNum = ticketIdToFiveDigit(t.id);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td class="ticket-id">${ticketNum}</td>
          <td>${t.appointmentDate || '-'}</td>
          <td>${t.appointmentTime || '-'}</td>
          <td>${t.status || '-'}</td>
          <td>${t.ticketType || '-'}</td>
          <td><button class="action-btn" onclick="viewTicketDetails('${t.id}')">View Details</button></td>
        `;
        historyBody.appendChild(row);
      });
    }

    // Real-time Firestore listener for full automation
    let unsubscribe = null;
    function fetchHistory(userId) {
      // Remove previous listener if any
      if (unsubscribe) unsubscribe();
      // Listen to ALL tickets for this user, no status filter!
      unsubscribe = db.collection("tickets")
        .where("userId", "==", userId)
        .onSnapshot(snapshot => {
          const tickets = [];
          snapshot.forEach(doc => {
            tickets.push({ id: doc.id, ...doc.data() });
          });
          // Sort by appointmentDate descending
          tickets.sort((a, b) => {
            if (!a.appointmentDate) return 1;
            if (!b.appointmentDate) return -1;
            return new Date(b.appointmentDate) - new Date(a.appointmentDate);
          });
          renderHistory(tickets);
        }, error => {
          const historyBody = document.getElementById('historyBody');
          historyBody.innerHTML = `<tr><td colspan="6" style="text-align:center; color: red;">Failed to load history.</td></tr>`;
          console.error(error);
        });
    }

    async function viewTicketDetails(ticketId) {
      const modalOverlay = document.getElementById('modalOverlay');
      const modalContent = document.getElementById('modalContent');
      modalContent.innerHTML = 'Loading details...';
      modalOverlay.classList.add('show');
      try {
        const doc = await db.collection("tickets").doc(ticketId).get();
        if (!doc.exists) {
          modalContent.innerHTML = `<div style="color:red;">Ticket not found.</div>`;
          return;
        }
        const t = doc.data();
        const ticketNum = ticketIdToFiveDigit(ticketId);
        modalContent.innerHTML = `
          <div><b>Ticket ID:</b> <span style="font-family:monospace;font-size:1.3rem;">${ticketNum}</span></div>
          <div><b>Appointment Date:</b> ${t.appointmentDate || '-'}</div>
          <div><b>Appointment Time:</b> ${t.appointmentTime || '-'}</div>
          <div><b>Status:</b> ${t.status || '-'}</div>
          <div><b>Type:</b> ${t.ticketType || '-'}</div>
          <div><b>Full Name:</b> ${t.fullName || '-'}</div>
          <div><b>Gender:</b> ${t.gender || '-'}</div>
          <div><b>Mobile:</b> ${t.mobile || '-'}</div>
        `;
      } catch (err) {
        modalContent.innerHTML = `<div style="color:red;">Failed to load details.</div>`;
      }
    }

    function closeModal() {
      document.getElementById('modalOverlay').classList.remove('show');
    }

    // Auth state: setup real-time listener after login
    auth.onAuthStateChanged(user => {
      if (user) {
        fetchHistory(user.uid);
      } else {
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
