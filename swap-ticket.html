<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Swap Ticket - WaitWizard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      background: linear-gradient(125deg,#f6fafb 0%,#f5f3ed 100%);
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 44px 0 60px;
    }
    .page-title {
      font-size: 3.2rem;
      color: #355f6b;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      margin-bottom: 10px;
      letter-spacing: 1px;
    }
    .subtitle {
      color: #57768c;
      text-align: center;
      font-size: 1.1rem;
      margin-bottom: 40px;
    }
    .container { width: 90%; max-width: 800px; margin: 0 auto; }
    .tickets-section, .notifications-section {
      margin-bottom: 45px;
    }
    .section-title {
      color: #365f6b;
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 18px;
      text-align: left;
      letter-spacing: 0.8px;
    }
    .ticket, .swap-request, .notification {
      background: #fff;
      border-radius: 18px;
      box-shadow: 0 6px 22px rgba(60, 80, 120, 0.10);
      padding: 22px 26px 20px 26px;
      margin-bottom: 24px;
      font-size: 1.08rem;
      transition: all 0.2s ease-in-out;
      max-width: 98vw;
    }
    .ticket:hover, .swap-request:hover, .notification:hover {
      box-shadow: 0 14px 34px rgba(80, 120, 96, 0.14);
      transform: translateY(-2px);
    }
    button {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 1.06rem;
      cursor: pointer;
      margin-top: 13px;
      margin-right: 8px;
      font-weight: 500;
      transition: background .18s;
    }
    button:hover { background: #45a049; }
    button.danger { background: #e74c3c;}
    button.danger:hover {background: #c0392b;}
    .ticket-id-number {
      font-family: monospace;
      font-weight: bold;
      color: #365f6b;
      padding-left: 2px;
      background: none;
      white-space: nowrap;
      letter-spacing: 1.3px;
      font-size: 1.10em;
    }
    @media (max-width: 700px) {
      .page-title { font-size: 2.1rem; }
      .section-title { font-size: 1.25rem; }
      .ticket, .swap-request, .notification { font-size: 0.97rem; padding: 10px; }
      button { font-size: 0.97rem; padding: 7px 11px;}
      .container { max-width: 99vw; padding: 0 2vw; }
    }
  </style>
</head>
<body>
  <div class="page-title">Swap Ticket</div>
  <div class="subtitle">Request swaps, respond to offers, and view notifications</div>
  <div class="container">
    <div class="tickets-section">
      <div class="section-title">Your Open Tickets</div>
      <div id="userTickets">Loading...</div>
    </div>

    <div class="tickets-section">
      <div class="section-title">Incoming Swap Requests</div>
      <div id="swapRequests">Loading...</div>
    </div>

    <div class="notifications-section">
      <div class="section-title">Swap Notifications</div>
      <div id="swapNotifications">Loading...</div>
    </div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCsy799iekDizixCe0LEGJWC-msj6MsvIs",
      authDomain: "digitalqueuesystem.firebaseapp.com",
      databaseURL: "https://digitalqueuesystem-default-rtdb.firebaseio.com",
      projectId: "digitalqueuesystem",
      storageBucket: "digitalqueuesystem.appspot.com",
      messagingSenderId: "934641075368",
      appId: "1:934641075368:web:fa23d50116ef2fd92e6e9d",
      measurementId: "G-TJESH8R15H"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    function ticketIdToFiveDigit(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = ((hash << 5) - hash) + str.charCodeAt(i);
        hash |= 0;
      }
      const num = Math.abs(hash % 100000);
      return num.toString().padStart(5, '0');
    }

    function renderTickets(tickets) {
      const c = document.getElementById('userTickets');
      c.innerHTML = "";
      if (!tickets.length) {
        c.textContent = 'No open tickets found.';
        return;
      }
      tickets.forEach(t => {
        const numericTicketId = ticketIdToFiveDigit(t.id);
        c.innerHTML += `
          <div class="ticket">
            <div><b>Ticket ID:</b> <span class="ticket-id-number">${numericTicketId}</span></div>
            <div><b>Appointment:</b> ${t.appointmentDate} at ${t.appointmentTime}</div>
            <div><b>Status:</b> ${t.status}</div>
            <button onclick="requestSwap('${t.id}')">Request Swap</button>
          </div>
        `;
      });
    }

    async function fetchTickets(uid) {
      const snap = await db.collection("tickets")
        .where("userId", "==", uid)
        .where("status", "==", "Open")
        .get();
      const arr = [];
      snap.forEach(doc => arr.push({ id: doc.id, ...doc.data() }));
      renderTickets(arr);
    }

    window.requestSwap = async function(ticketId) {
      const uid = auth.currentUser.uid;
      await db.collection("swapRequests").add({
        fromUser: uid,
        fromTicketId: ticketId,
        toUser: null,
        toTicketId: ticketId,
        status: "pending",
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Swap request broadcasted! Other users can now see it.");
    };

    function renderSwapRequests(reqs) {
      const c = document.getElementById('swapRequests');
      c.innerHTML = "";
      if (!reqs.length) {
        c.textContent = 'No incoming swap requests.';
        return;
      }
      const shownReqs = new Set();
      reqs.forEach(r => {
        if (shownReqs.has(r.id)) return;
        shownReqs.add(r.id);
        const numericFromTicketId = ticketIdToFiveDigit(r.fromTicketId);
        const numericFromUserId = ticketIdToFiveDigit(r.fromUser);
        c.innerHTML += `
          <div class="swap-request">
            <div><b>From User:</b> <span class="ticket-id-number">${numericFromUserId}</span></div>
            <div><b>Ticket:</b> <span class="ticket-id-number">${numericFromTicketId}</span></div>
            <button onclick="acceptSwap('${r.id}', '${r.fromTicketId}', '${r.toTicketId}')">Accept</button>
            <button class="danger" onclick="declineSwap('${r.id}')">Decline</button>
          </div>
        `;
      });
    }

    async function fetchSwapRequests(uid) {
      const snap = await db.collection("swapRequests")
        .where("status", "==", "pending")
        .get();
      const arr = [];
      snap.forEach(doc => {
        const r = { id: doc.id, ...doc.data() };
        if ((r.toUser === uid || r.toUser === null) && r.fromUser !== uid) {
          arr.push(r);
        }
      });
      renderSwapRequests(arr);
    }

    window.acceptSwap = async function(reqId, fromTicketId, toTicketId) {
      if (!confirm("Accept this swap?")) return;

      const fromDoc = await db.collection("tickets").doc(fromTicketId).get();
      const toDoc = await db.collection("tickets").doc(toTicketId).get();
      if (!fromDoc.exists || !toDoc.exists) {
        alert("One of the tickets no longer exists.");
        return;
      }
      const fromData = fromDoc.data();
      const toData = toDoc.data();

      // Swap appointment date/time AND mark both as "Swapped"
      await db.collection("tickets").doc(fromTicketId).update({
        appointmentDate: toData.appointmentDate,
        appointmentTime: toData.appointmentTime,
        status: "Swapped"
      });
      await db.collection("tickets").doc(toTicketId).update({
        appointmentDate: fromData.appointmentDate,
        appointmentTime: fromData.appointmentTime,
        status: "Swapped"
      });
      await db.collection("swapRequests").doc(reqId).update({ status: "accepted" });

      alert("Swap completed!");

      fetchSwapRequests(auth.currentUser.uid);
      fetchSwapNotifications(auth.currentUser.uid);
    };

    window.declineSwap = async function(reqId) {
      if (!confirm("Decline this request?")) return;
      await db.collection("swapRequests").doc(reqId).update({ status: "declined" });
      alert("Request declined.");
      fetchSwapRequests(auth.currentUser.uid);
    };

    function renderSwapNotifications(notifications) {
      const c = document.getElementById('swapNotifications');
      c.innerHTML = "";
      if (!notifications.length) {
        c.textContent = 'No new swap notifications.';
        return;
      }
      notifications.forEach(n => {
        const numericFromTicketId = ticketIdToFiveDigit(n.fromTicketId);
        const numericToTicketId = ticketIdToFiveDigit(n.toTicketId);
        c.innerHTML += `
          <div class="notification">
            <div><b>Swap Accepted:</b> Your ticket <span class="ticket-id-number">${numericToTicketId}</span> was swapped with ticket <span class="ticket-id-number">${numericFromTicketId}</span> from another user.</div>
          </div>
        `;
      });
    }

    async function fetchSwapNotifications(uid) {
      const snap = await db.collection("swapRequests")
        .where("status", "==", "accepted")
        .get();
      const arr = [];
      snap.forEach(doc => {
        const n = { id: doc.id, ...doc.data() };
        // Show notifications relevant to this user (where they had 'toUser' or 'fromUser')
        if (n.toUser === uid || n.fromUser === uid) {
          arr.push(n);
        }
      });
      renderSwapNotifications(arr);
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        fetchTickets(user.uid);
        fetchSwapRequests(user.uid);
        fetchSwapNotifications(user.uid);
      } else {
        window.location.href = "index.html";
      }
    });
  </script>
</body>
</html>
